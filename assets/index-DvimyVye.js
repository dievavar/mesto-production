(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const i of n.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();const T={baseUrl:"https://mesto.nomoreparties.co/v1/apf-cohort-202",headers:{authorization:"8e7cf59b-e0cf-47b5-9c22-22076bf6e2bd","Content-Type":"application/json"}},z=e=>e.ok?e.json():Promise.reject(new Error(`API error: ${e.status}`)),p=(e,t={})=>fetch(`${T.baseUrl}${e}`,{headers:T.headers,...t}).then(z),R=()=>p("/users/me"),K=({name:e,about:t})=>p("/users/me",{method:"PATCH",body:JSON.stringify({name:e,about:t})}),G=({avatar:e})=>p("/users/me/avatar",{method:"PATCH",body:JSON.stringify({avatar:e})}),B=()=>p("/cards"),Q=({name:e,link:t})=>p("/cards",{method:"POST",body:JSON.stringify({name:e,link:t})}),V=e=>p(`/cards/${e}`,{method:"DELETE"}),X=(e,t)=>p(`/cards/likes/${e}`,{method:t?"DELETE":"PUT"}),Y=()=>document.getElementById("card-template").content.querySelector(".card").cloneNode(!0),F=(e,{onPreviewPicture:t,onLikeIcon:o,onDeleteCard:s,currentUserId:r})=>{const n=Y(),i=n.querySelector(".card__like-button"),a=n.querySelector(".card__like-count"),h=n.querySelector(".card__control-button_type_delete"),c=n.querySelector(".card__image"),l=n.querySelector(".card__title");return c.src=e.link,c.alt=e.name,l.textContent=e.name,t&&c.addEventListener("click",()=>t({name:e.name,link:e.link})),a&&(a.textContent=e.likes.length),e.likes.some(q=>q._id===r)&&i.classList.add("card__like-button_is-active"),o&&i.addEventListener("click",()=>{const q=i.classList.contains("card__like-button_is-active");o(e._id,q,i,a)}),e.owner&&e.owner._id===r?s&&h.addEventListener("click",()=>s(e._id,n)):h.remove(),n},N=e=>{if(e.key==="Escape"){const t=document.querySelector(".popup_is-opened");m(t)}},S=e=>{e.classList.add("popup_is-opened"),document.addEventListener("keyup",N)},m=e=>{e.classList.remove("popup_is-opened"),document.removeEventListener("keyup",N)},Z=e=>{e.querySelector(".popup__close").addEventListener("click",()=>{m(e)}),e.addEventListener("mousedown",o=>{o.target.classList.contains("popup")&&m(e)})},U=document.querySelector(".places__list"),C=document.querySelector(".popup_type_edit"),f=C.querySelector(".popup__form"),$=f.querySelector(".popup__input_type_name"),W=f.querySelector(".popup__input_type_description"),b=document.querySelector(".popup_type_new-card"),u=b.querySelector(".popup__form"),ee=u.querySelector(".popup__input_type_card-name"),te=u.querySelector(".popup__input_type_url"),E=document.querySelector(".popup_type_image"),O=E.querySelector(".popup__image"),oe=E.querySelector(".popup__caption"),ne=document.querySelector(".profile__edit-button"),re=document.querySelector(".profile__add-button"),k=document.querySelector(".profile__title"),w=document.querySelector(".profile__description"),x=document.querySelector(".profile__image"),P=document.querySelector(".popup_type_edit-avatar"),y=P.querySelector(".popup__form"),ce=y.querySelector(".popup__input"),se=document.querySelector(".header__logo"),v=document.querySelector(".popup_type_info"),d=v.querySelector(".popup__info"),ie=v.querySelector(".popup__text"),D=v.querySelector(".popup__list"),le=document.querySelector("#popup-info-definition-template").content,ae=document.querySelector("#popup-info-user-preview-template").content;let L=null;const H=({name:e,link:t})=>{O.src=t,O.alt=e,oe.textContent=e,S(E)},g=(e,t)=>{const o=e.querySelector('button[type="submit"]');o&&(o.textContent=t)},ue=e=>{e.preventDefault(),g(f,"Сохранение..."),K({name:$.value,about:W.value}).then(t=>{k.textContent=t.name,w.textContent=t.about,m(C)}).catch(t=>console.log(t)).finally(()=>g(f,"Сохранить"))},pe=e=>{e.preventDefault();const t=y.querySelector('button[type="submit"]');t.textContent="Сохранение...",G({avatar:ce.value}).then(o=>{x.style.backgroundImage=`url(${o.avatar})`,m(P),y.reset()}).catch(o=>console.log(o)).finally(()=>{t.textContent="Сохранить"})},j=(e,t)=>{V(e).then(()=>{t.remove()}).catch(o=>console.log(o))},de=e=>{e.preventDefault(),g(u,"Создание..."),Q({name:ee.value,link:te.value}).then(t=>{U.prepend(F(t,{onPreviewPicture:H,onLikeIcon:J,onDeleteCard:j,currentUserId:L})),m(b),u.reset()}).catch(t=>console.log(t)).finally(()=>g(u,"Создать"))},J=(e,t,o,s)=>{X(e,t).then(r=>{s&&(s.textContent=r.likes.length),o.classList.toggle("card__like-button_is-active")}).catch(r=>console.log(r))};f.addEventListener("submit",ue);u.addEventListener("submit",de);y.addEventListener("submit",pe);ne.addEventListener("click",()=>{$.value=k.textContent,W.value=w.textContent,S(C)});x.addEventListener("click",()=>{y.reset(),S(P)});re.addEventListener("click",()=>{u.reset(),S(b)});const me=document.querySelectorAll(".popup");me.forEach(e=>{Z(e)});Promise.all([R(),B()]).then(([e,t])=>{L=e._id,k.textContent=e.name,w.textContent=e.about,x.style.backgroundImage=`url(${e.avatar})`,t.forEach(o=>{U.append(F(o,{onPreviewPicture:H,onLikeIcon:J,onDeleteCard:j,currentUserId:L}))})}).catch(e=>console.log(e));const A=e=>e.toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"}),_=(e,t)=>{const o=le.querySelector(".popup__info-item").cloneNode(!0);return o.querySelector(".popup__info-term").textContent=e,o.querySelector(".popup__info-description").textContent=t,o},_e=e=>{const t=ae.querySelector(".popup__list-item").cloneNode(!0);return t.textContent=e,t},fe=v.querySelector(".popup__title"),ye=()=>{fe.textContent="Статистика пользователей",d.innerHTML="",D.innerHTML="",ie.textContent="Все пользователи:",B().then(e=>{const t=[...e].sort((c,l)=>new Date(l.createdAt)-new Date(c.createdAt)),o=t.length,s=o?A(new Date(t[o-1].createdAt)):"—",r=o?A(new Date(t[0].createdAt)):"—",n=new Map;for(const c of t){const l=c.owner?._id??"unknown",M=c.owner?.name??"Без имени",I=n.get(l);n.set(l,{name:M,count:(I?.count??0)+1})}const i=n.size;let a=0;for(const c of n.values())c.count>a&&(a=c.count);d.append(_("Всего карточек:",String(o))),d.append(_("Первая создана:",s)),d.append(_("Последняя создана:",r)),d.append(_("Всего пользователей:",String(i))),d.append(_("Максимум карточек от одного:",String(a))),[...n.values()].map(c=>c.name).sort((c,l)=>c.localeCompare(l,"ru")).forEach(c=>{D.append(_e(c))}),S(v)}).catch(e=>console.log(e))};se.addEventListener("click",ye);
